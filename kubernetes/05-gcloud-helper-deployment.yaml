apiVersion: apps/v1
kind: Deployment
metadata:
  name: gcloud-helper-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gcloud-helper
  template:
    metadata:
      labels:
        app: gcloud-helper
    spec:
      serviceAccountName: gcloud-helper-sa
      containers:
      - name: gcloud-helper
        image: google/cloud-sdk:alpine
        command: ["/bin/sh", "-c"]
        args:
          - |
            apk add --no-cache python3 py3-pip && \
            pip3 install flask && \
            cat > /app/server.py << 'EOF'
            from flask import Flask, request, jsonify
            import subprocess
            import json

            app = Flask(__name__)

            ALLOWED_COMMANDS = {
                'list_instances': ['gcloud', 'compute', 'instances', 'list', '--format=json'],
                'list_zones': ['gcloud', 'compute', zones', 'list', '--format=json'],
                'list_regions': ['gcloud', 'compute', 'regions', 'list', '--format=json'],
                'list_machine_types': ['gcloud', 'compute', 'machine-types', 'list', '--format=json'],
                'describe_project': ['gcloud', 'compute', 'project-info', 'describe', '--format=json']
            }

            @app.route('/health', methods=['GET'])
            def health():
                return jsonify({"status": "healthy"}), 200

            @app.route('/execute', methods=['POST'])
            def execute_command():
                try:
                    data = request.get_json()
                    command_name = data.get('command')

                    if command_name not in ALLOWED_COMMANDS:
                        return jsonify({"error": "Command not allowed"}), 403

                    command = ALLOWED_COMMANDS[command_name]
                    result = subprocess.run(command, capture_output=True, text=True, timeout=30)

                    if result.returncode == 0:
                        try:
                            output = json.loads(result.stdout)
                        except json.JSONDecodeError:
                            output = result.stdout
                        return jsonify({"output": output}), 200
                    else:
                        return jsonify({"error": result.stderr}), 500

                except Exception as e:
                    return jsonify({"error": str(e)}), 500

            if __name__ == '__main__':
                app.run(host='0.0.0.0', port=8080)
            EOF
            mkdir -p /app && python3 /app/server.py
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: gcloud-helper-service
spec:
  selector:
    app: gcloud-helper
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  type: ClusterIP
